<include file="head" title="首页 - 有方科技"/>

<!--导入css文件-->
<load href="__PUBLIC__/Css/Admin_Home.css"/>

<!--导入分类树样式-->
<link href="__PUBLIC__/Css/mtree.css" rel="stylesheet" type="text/css">
<style>
    .mtree-demo .mtree {
        background: #EEE;
        margin: 20px auto;
        max-width: 320px;
        border-radius: 3px;
    }
    .mtree li{
        font-size: 18px;
    }
    
    .dropdown-menu  li  a {
        display: block;
        padding: 3px 20px;
        clear: both;
        font-weight: normal;
        line-height: 1.42857143;
        color: #333;
        white-space: nowrap;
    }
    .dropdown-menu  li  a:hover,
    .dropdown-menu  li  a:focus {
        color: #262626;
        text-decoration: none;
        background-color: #f5f5f5;
    }
    .dropdown-menu  .active  a,
    .dropdown-menu  .active  a:hover,
    .dropdown-menu  .active  a:focus {
        color: #fff;
        text-decoration: none;
        background-color: #337ab7;
        outline: 0;
    }
    .folderF{
        color: #cccccc;
        font-size: 20px;
        margin-right: 10px;
        cursor: not-allowed;
    }
    .folderT{
        color: #00cccc;
        font-size: 20px;
        margin-right: 10px;
        cursor: pointer;
    }
</style>

<div id="pageheader">
    <div class="container">
        <!--上传框提示信息-->
<!--        <div class="modal fade" id="uploadModal" data-backdrop="static">
            <div class="modal-dialog" style="margin: 200px auto;width: 450px;height: 550px;">
                <div class="modal-content">
                    <div class="modal-body" style="margin: 20px;">
                        <span id="modalBodyText">请选择文件后，再上传！</span>
                    </div>
                    <div class="modal-footer">
                        <span id="countDown" style="font-weight: bold;font-size: large;color: #0055FF;">2</span>秒后，
                        <button class="btn btn-sm btn-primary" id="modalButton" data-dismiss="modal" type="button">确认</button>
                        <button class='btn btn-sm btn-default hidden' id='modalFButton' data-dismiss='modal'>取消</button>
                    </div>
                </div>
            </div>
        </div>-->

        <!--导航栏-->
        <div style="float:left;min-width: 20%;margin-right: 30px;margin-top: 10px;">
            <ul id="navUl" class="mtree jet" name="ul" style="background-color: #f5f5f5;">
                <for start="1" end="sizeof($lists)">
                    <if condition="$lists[$i] eq 'ul'">
                        <ul name="ul">
                    </if>
                    <if condition="$lists[$i] eq '/ul'" > 
                        <if condition="$lists[$i+1] neq ''">
                            </ul></li>
                            <else /> </ul>
                        </if>
                    </if>
                    <if condition="is_array($lists[$i])">
                        <if condition="$lists[$i+1] eq 'ul'">
                            <li name="li" value="<{$lists[$i][0]}>"><a id="<{$lists[$i][2]}>" href="__URL__/home?root=<{$lists[$i][0]}>"><{$lists[$i][1]}></a>
                            <else />  <li name="li" value="<{$lists[$i][0]}>"><a id="<{$lists[$i][2]}>" href="__URL__/home?root=<{$lists[$i][0]}>"><{$lists[$i][1]}></a></li>
                        </if>
                    </if>
                </for>
                <!--文件目录操作，添加，修改，删除-->
                <div id="folderIcon" style="text-align: center;">
                    <span class="glyphicon glyphicon-plus folderT" onclick="folderAdd()" ></span>
                    <span class="glyphicon glyphicon-pencil folderT" onclick="folderEdit()" ></span>
                    <span class="glyphicon glyphicon-trash folderT" onclick="folderDel()" ></span>
                </div>
                <div id="folderDiv" class="hidden" style="text-align: center;">
                    <form class="form-group" id="folderForm" action="__URL__/folder" method="post">
                        <input id="folderName" name="folderName" type="text" placeholder="请输入文件夹的名称" >
                        <!--<input id="parentId" name="parentId" type="hidden" value="" >-->
                        <input id="catId" name="catId" type="hidden" value="">
                        <input id="operation" name="operation" type="hidden" value="">
                        <button class="btn btn-sm btn-default" type="button" onclick="folderConfirm()">确定</button>
                        <button class="btn btn-sm btn-default" type="button" onclick="folderCancel()">取消</button>
                    </form>
                </div>

        </div>

        <!--文件列表-->
        <div class="table-div table-responsive">
            <table class="table table-striped table-condensed">
                <thead>
                    <tr>
                        <th style="width:10%;">序号</th>
                        <th style="width:30%;">文件名</th>
                        <th id="tr-path" style="width:20%;">路径</th>
                        <th id="tr-size" style="width:5%;">大小</th>
                        <th id="tr-date" style="width:15%;">日期</th>
                        <th style="width:15%;">生成二维码</th>
                        <th style="width:5%;">删除</th>
                    </tr>
                </thead>
                <tbody>
                <if condition="$files eq ''">
                    <tr>
                        <td colspan='7'>
                            <div style='height: 100px;vertical-align: middle;line-height: 100px;font-size: 18px;'>暂未查询到数据，请检查后重新查询！</div>
                        </td>
                    </tr>
                </if>
                <volist id="f" name="files">
                    <tr>
                        <td id="td-content">
                            <input name="che" id="<{$f.fileid}>" type="checkbox" onchange="is_all()"/>&nbsp;<{$i}>
                        </td>
                        <td id="td-content">
                            <a href="__URL__/download?filename=<{$f.filename}>" style="text-decoration: none;" title="<{$f.filename}>"><{$f.shortname}></a>
                        </td>
                        <td id="td-path">./Public/Uploads</td>
                        <td id="td-size"><{$f.size}></td>
                        <td id="td-date"><php>echo date("Y.m.d H:i",strtotime($f["uploadtime"]))</php></td>
                        <td id="td-pic">
                            <button class="btn btn-default" type="button" onclick="location.href = '__URL__/create_qr?fileid=<{$f.fileid}>'"><span class="glyphicon glyphicon-qrcode"></span></button>
                        </td>
                        <td id="td-pic"><button class="btn btn-default" type="button" onclick="todel( < {$f.fileid} > )"><span class="glyphicon glyphicon-trash"></span></button></td>
                    </tr>
                </volist>
                </tbody>
            </table>

            <!--button组-->
            <div id="bot" style="float:left;">
                <button class="btn btn-primary" type="button" onclick="allselect()">全选</button>
                <button class="btn btn-success" type="button" onclick="downloads()">下载</button>
                <button class="btn btn-info" type="button" onclick="deletes()">删除</button>
                
                <button class="btn btn-warning" type="button" onclick="uploadModalFunc()">上传文件</button>
            </div>

            <!--上传-->
            <div class="modal fade" id="uploadTModal">
                <div class="modal-dialog" style="margin: 200px auto;width: 450px;height: 750px;">
                    <div class="modal-content">
                        <div class="modal-body" style="margin: 20px;">
                            <div>
                                <form class="form-group-md" id="up_form" action="__URL__/upload" method="post" enctype="multipart/form-data">
                                    <input id="folderId" name="folderId" style="display: none;" type="text" value="">
                                    <input class="hidden" id="coverUpload" name="coverUpload" type="text">
                                    <div class="upload-div input-group">
                                        <input class="form-control upload-text" id="text" name="filename" type="text"
                                               value="点击上传文件" onclick="document.getElementById('fil').click()" readonly="readonly">
                                    </div>
                                    <input id="fil" type="file"  name="upfile" style="display:none;"  onChange="document.getElementById('text').value = this.value">
                                    <input class="hidden" id="res" type="reset">
                                    
                                    <!--下拉框-->
                                    <div class="btn-group" id="btnul" style="margin-top:10px;">
                                        <button type="button" class="btn btn-primary dropdown-toggle"  id="btn"
                                                data-toggle="dropdown">
                                            请选择文件夹 <span class="caret"></span>
                                        </button>
                                        <ul class="dropdown-menu" role="menu">
                                            <li value="0"><a href="javascript:;">根目录</a>
                                            <for start="1" end="sizeof($lists)">
                                                <if condition="$lists[$i] eq 'ul'">
                                                    <ul>
                                                </if>
                                                <if condition="$lists[$i] eq '/ul'" > 
                                                    <if condition="$lists[$i+1] neq ''">
                                                        </ul></li>
                                                        <else /> </ul>
                                                    </if>
                                                </if>
                                                <if condition="is_array($lists[$i])">
                                                    <if condition="$lists[$i+1] eq 'ul'">
                                                        <li value="<{$lists[$i][0]}>"><a href="javascript:;"><{$lists[$i][1]}></a>
                                                        <elseif condition="$lists[$i][1] neq '...'"/>
                                                        <li value="<{$lists[$i][0]}>"><a href="javascript:;"><{$lists[$i][1]}></a></li>
                                                    </if>
                                                </if>
                                            </for>
                                    </div>
                                </form>
                            </div>
                            
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-md btn-primary" type="button" onclick="isUpload()">上传</button>
                            <button class='btn btn-md btn-default' id='' data-dismiss='modal'>取消</button>
                        </div>
                    </div>
                </div>
            </div>

            <!--分页-->
            <div class="fenye jogger pull-right"><{$show}></div>
        </div>

    </div>
</div>

<input type="hidden" value="<{$parentCode}>" id="parentCode"/>
<input type="hidden" value="<{$dialog_filename}>" id="dialog_file"/><!--弹出框二维码图片的名称-->
<!--导入js文件-->
<script language="javascript" type="text/javascript" src="__PUBLIC__/Js/zDrag.js"></script>  <!--二维码弹出框-->
<script language="javascript" type="text/javascript" src="__PUBLIC__/Js/zDialog.js"></script><!--二维码弹出框-->
<script language="javascript"  type="text/javascript"  src="__PUBLIC__/Js/jquery-1.9.1.js"></script>
<script language="javascript"  type="text/javascript"  src="__PUBLIC__/Js/Admin_Home.js"></script>

<script language="javascript"  type="text/javascript"  src="__PUBLIC__/plugins/jQuery/jQuery-2.1.4.min.js"></script>
<script language="javascript"  type="text/javascript"  src="__PUBLIC__/plugins/bootstrap-3.3.5-dist/js/bootstrap.min.js"></script>

<script src='__PUBLIC__/Js/jquery.velocity.min.js'></script> 
<script src="__PUBLIC__/Js/mtree.js"></script> 
<script type="text/javascript">
//    记忆上次打开的目录
    $(function() {
        var parent = $('#parentCode').val();
        console.log(parent);
        parent = parent.split("-");
        console.log("indexof," + parent[0].indexOf(','));
        if (parent[0].indexOf(',') >= 0) {
            //            ...目录
            console.log("charAt=" + parent[0].charAt(parent[0].length - 1));
            if (parent[0].charAt(parent[0].length - 1) == ',') {
                i0 = parent[0].substr(0, parent[0].length - 1);
                i0 = i0.replace(/,/g, 'a');
                console.log("i0=" + i0);
            } else {
                i0 = parent[0].replace(/,/g, 'a');
                console.log("i0=" + i0);
            }

            for (i = parent.length - 2; i > 0; i--) {
                console.log("parent[i]=" + parent[i]);
                $("#" + parent[i]).click();
            }
            $("#" + i0).click();
        } else {
            //            正常目录
            for (i = parent.length - 2; i >= 0; i--) {
                console.log("parent[i]=" + parent[i]);
                $("#" + parent[i]).click();
            }
        }
        $("#catId").val($('.mtree-active >a').attr("id"));
        folderIsEdit();
        
        //上传文件时，点击文件夹响应
        $("#btnul a").click(function() {
            $('#btn').html($(this).text() + '&nbsp;&nbsp;<span class="caret"></span>');
            $('#folderId').val($(this).parent().attr('value'));
        });
        
        //导航栏更改后，改变folderIcon和id
        $("#navUl a").click(function() {
            //改变将要修改文件目录的id
            $("#catId").val($(this).attr("id"));
            
            folderIsEdit();
        });
        
        // 初始化catId，用于文件目录操作
        $("#catId").val($('.mtree-active').children().eq(0).attr("id"));
        
        //模态框隐藏，初始化文件框和文件目录下拉框
        $('#uploadTModal').on('hidden.bs.modal', function () {
            $('#text').css("border-color","");
            $('#btn').attr("class","btn btn-primary dropdown-toggle");
          });
    });
    
    //点击上传文件按钮，显示上传文件模态框
    function uploadModalFunc(){
        $('#uploadTModal').modal('show');
        $('#text').click();
    }
    
    //检查是否可以上传文件
    function isUpload(){
        if(!$("#folderId").val()){
            $('#btn').attr("class","btn btn-danger dropdown-toggle");
        }
        if($("#text").val()=="点击上传文件"){
            $('#text').css("border-color","red");
        }
        if($("#folderId").val() && $("#text").val()!="点击上传文件"){
            upToDatabase();
        }
    }
    
    //判断文件夹是否可编辑
    function folderIsEdit(){
//        alert($(".mtree-active").children().eq(0).text());
        //text()为...，
        if($(".mtree-active").children().eq(0).text()=="..."){
            $("#folderIcon span").removeClass("folderT").addClass("folderF");
        }else{
            //text()为空，是根目录，根目录只可以创建目录，修改和删除图标置为灰色
//            alert("catId="+$("#catId").val());
            if($("#catId").val()==''){
                $("#folderIcon").children().eq(1).removeClass("folderT").addClass("folderF");
                $("#folderIcon").children().eq(2).removeClass("folderT").addClass("folderF");
            }else{
                $("#folderIcon span").removeClass("folderF").addClass("folderT");
            }
        }
    }
    
    //增加文件夹，folderIcon
    function folderAdd(){
        $("#operation").val("add");
        if($("#folderIcon").children().eq(0).hasClass("folderT")){
            $("#folderDiv").attr("class","show");
            $("#folderName").focus().select();
        }
    }
    
    //修改文件夹，folderIcon
    function folderEdit(){
        $("#operation").val("edit");
        if($("#folderIcon").children().eq(1).hasClass("folderT")){
            $("#folderDiv").attr("class","show");
            // 获取文件夹名
            id=$("#catId").val();
            folder=$("#"+id).text();
            $("#folderName").attr("value",folder).focus().select();
        }
    }
    
    //删除文件夹，folderIcon
    function folderDel(){
        if($("#folderIcon").children().eq(2).hasClass("folderT")){
            var catId=$('#catId').val();
            $.ajax({
                type: "POST",
                url: "__URL__/isDel",
                data: {cat_id: catId},
                success: function(returnData) {
                    if (returnData.status == "1") {
                        //可以删除该文件夹
                        if(confirm("确实要删除'"+returnData.folder+"'文件夹吗")){
                            window.location.href = "__URL__/toDel?catId="+catId;
                        }
                    } else {
                        //不能删除该文件夹的情况，1.有子文件夹；2.文件夹下有文件
                        //返回数据中可添加，不可删除的原因
                        alert("对不起，该文件夹不可删除！");
                    }
                }
            },"json");
        }
    }
    
    //文件夹目录增改，确认按钮操作
    function folderConfirm(){
        if($("#folderName").val()){
            $("#folderForm").submit();
        }else{
//            alert("value="+$("#folderName").css('border-color'));
            $("#folderName").css('border-color',"red");
        }
    }
    
    //取消文件夹增改
    function folderCancel(){
        $("#folderDiv").attr("class","hidden");
        $("#folderName").css('border-color',"");
    }
</script>

<include file="foot"/>